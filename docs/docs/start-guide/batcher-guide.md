---
sidebar_position: 1
description: "在大部分游戏的开发中享受不用担心 Draw Call 的快乐。"
---

# 新 UI 渲染批次合并指南

在官方文档的进阶主题中，有一个 [UI 渲染批次合并指南](https://docs.cocos.com/creator/2.4/manual/zh/advanced-topics/ui-auto-batch.html)，而由于服务包的 **多纹理渲染**、**重构动态图集** 等新特性的出现，有一些内容可能已经过期。

如果你未阅读过官方的指南，可以先看一看里面的知识科普部分，而我们将直接从如何实践开始！

---
## 什么是多纹理渲染？

在以前的认识里，我们知道相邻的节点使用不同的纹理（Texture）会导致不能合并批次。

其根本原因是纹理是使用 uniform 变量传给着色器的，而需要合并批次的话不允许每次渲染都拥有不同的 uniform 变量值。

服务包实现的合批方法是先设置好多个 uniform 变量，比如将 8 张纹理写入到 "texture1" "texture2" "texture3"... 的 8 个 uniform 变量中，然后编写一个着色器判断应该在渲染时使用哪个 uniform 变量。

这样的话如果所有渲染都只用这 8 张纹理的话，就都能合并为 1 个批次。

这种做法要求设备需要支持采样多个纹理，而在现代绝大多数设备中这不是问题，至少都支持采样 8 张纹理。

当然除了这种方法，还有另外的一些进行多纹理合批的方法，例如 "Texture Array"、"Bindless"，但都有实用性与兼容性的问题。

:::info 提示

以这种方式实现的多纹理渲染并不是没有弊端的：

因为会多传递一个顶点属性，并且需要在着色器中去判断该使用哪个纹理，这可能也会造成性能下降，毕竟**合并批次并不一定会提升性能**。

所以我们建议在多个档次设备中实际测试项目是否使用多纹理渲染的性能差距。

如果你还有所担心，就像我们在实现这个功能之前一样，可以看看这些：

**PixiJS 引擎在 2016 年发布的 v4 版本就已经正式实装了多纹理渲染机制！**[资料出处](https://medium.com/goodboy-digital/gpu-multi-texture-sprite-batching-21c90ae8f89b)。

**Phaser 引擎在 v4 与 v3 版本都实装了多纹理渲染机制（2019 - 2020年）**[资料出处](https://www.patreon.com/posts/39665256)。

:::

---
## 为你的项目启用动态合图

在项目原来的开发中，我们可能会关闭动态图集，更倾向于靠静态图集或者自动图集达到降低 Draw Call 的目的。

这种选择除了与动态合图存在会占用更多内存的缺点有关之外，更多的是在引擎原来的动态合图中，并不能复用图集的废弃区域，这个重要特性的缺失只能靠在切换场景（Scene）后重置所有图集来解决。

但对于大部分项目来说，这种治标不治本的机制基本等于没有解决这个问题。

而现在，**服务包几乎重构了整个动态合图系统，解决了以前存在的大部分问题**，你可以启用它了。

:::note 提示

开启动态图集常见的反对意见是：

在部分小游戏平台里，启用动态图集会有保留 Image 对象所占用的内存空间很大的问题。

我们建议：

- 请实际测试是否启用动态图集的内存占用差距。
- 有没有一种可能，只是说可能，出现不能接受的内存占用大小是因为你的项目根本就不做任何资源的释放呢？

:::

---
## 充分利用动态合图

启用动态合图后，我们有几个小提示能让你发挥出动态合图的潜力：

### 放宽能参与合图的纹理尺寸限制

你可以适当地放宽能参与合图的纹理尺寸的限制（`cc.dynamicAtlasManager.maxFrameSize`）。

推荐设置为 `512`、 `1024` 甚至 `2048`。

因为**动态图集会自动进行多纹理合批，你可以放心地使用多达 8 张图集而不用担心交叉渲染导致的打断批次！**

:::tip 

服务包会将动态图集默认的最大数量自动调整至与设备能同时采样的纹理数一致，这个值一般为 `8`。

:::

### 无需管理动态图集，只需要释放资源

**动态合图支持复用废弃空间，释放纹理的同时会释放其在动态图集使用的空间。**

所以一般不需要去关心动态图集，只需要做好资源释放，就不会发生动态图集被用完的情况。

### 更加细致地优化图集的使用效率

除了引擎自带的 `packable` 属性可以控制纹理是否会参与动态合图之外。

服务包还额外支持了**控制组件是否默认参与动态合图，也可以控制单个组件是否参与动态合图。**

有关动态合图的设置可前往 [动态合图](TODO) 的文档了解详情。

在上面我们推荐可以将纹理尺寸限制放宽到 `2048`，这听起来貌似有点离谱，但只要规划好项目的资源确实可行，比如：

- **将优化程度有限但尺寸具大的纹理禁止参与动态合图**
- **分模块存放资源，将冷门界面（如活动）的纹理禁止参与动态合图，或尽早释放掉**
- **在资源已经一团糟的项目中，可以直接禁止渲染组件参与动态合图**

## Label 不再是合批的噩梦
